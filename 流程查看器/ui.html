<style>
	body {
		margin: 0;
		background-color: #fff;
		padding: 12px;
	}

	.radio-container {
		display: inline-block;
		position: relative;
		padding-left: 15px;
		cursor: pointer;
		font-size: 12px;
		user-select: none;
	}

	.radio-container input {
		position: absolute;
		opacity: 0;
		cursor: pointer;
	}

	.radio-checkmark {
		position: absolute;
		top: 3px;
		left: 0;
		height: 12px;
		width: 12px;
		background-color: #ccc;
		border-radius: 50%;
	}

	.radio-container:hover input~.radio-checkmark {
		background-color: #bbb;
	}

	.radio-container input:checked~.radio-checkmark {
		background-color: #2196F3;
	}

	.radio-checkmark:after {
		content: "";
		position: absolute;
		display: none;
	}

	.radio-container input:checked~.radio-checkmark:after {
		display: block;
	}

	.radio-container .radio-checkmark:after {
		top: 4px;
		left: 4px;
		width: 4px;
		height: 4px;
		border-radius: 50%;
		background: white;
	}



	.dropdown {
		position: relative;
		/* display: inline-block; */
	}

	.dropdown select {
		appearance: none;
		background-color: #f1f1f1;
		border: none;
		cursor: pointer;
		padding: 8px 16px;
		outline: none;
		font-size: 12px;
		color: #333;
		border-radius: 4px;
		width: 100%;
	}

	.dropdown::before {
		content: '▼';
		position: absolute;
		right: 8px;
		top: 50%;
		transform: translateY(-50%);
		pointer-events: none;
		font-size: 10px;
		color: #333;
	}


	.button {
		display: inline-block;
		background-color: #007BFF;
		color: white;
		padding: 8px 16px;
		font-size: 16px;
		border: none;
		border-radius: 4px;
		cursor: pointer;
		text-decoration: none;
		transition: background-color 0.3s, box-shadow 0.3s;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.button:hover {
		background-color: #0056B3;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
	}

	.button:active {
		background-color: #004085;
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
	}

	.mini-button {
		padding: 4px 8px;
		font-size: 8px;
	}



	.title {
		color: #333;
		font-size: 12px;
		margin-bottom: 4px;
	}

	.border {
		border: 1px solid #f5f5f5;
		box-sizing: border-box;
		padding: 4px;
		margin-bottom: 8px;
	}

	.max-height {
		height: 300px;
		max-height: 300px;
	}

	.ppt_container {
		display: flex;
	}

	.ppt_meun {
		width: 200px;
		flex-shrink: 0;
		overflow: auto;
		padding: 0 8px;
		border-right: 1px solid #f5f5f5;
	}

	.list-item {
		display: flex;
		align-items: center;
		background-color: #f1f1f1;
		color: #333;
		padding: 8px 16px;
		margin-bottom: 4px;
		font-size: 16px;
		border-radius: 4px;
		cursor: pointer;
		text-decoration: none;
		transition: background-color 0.3s;
	}

	.list-item:hover {
		background-color: #e1e1e1;
	}

	.list-item.active {
		background-color: #0056B3;
		color: #fff;
	}

	.content {
		flex: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		background-color: #f2f2f2;
		position: relative;
	}

	.del_icon {
		position: absolute;
		width: 20px;
		height: 20px;
		right: 40px;
		top: 20px;
		cursor: pointer;
	}

	.content_main {
		background-color: #fff;
		width: 300px;
		height: 168px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.content_show {
		width: 300px;
		height: 168px;
	}



	.stylish-input {
		background-color: #f1f1f1;
		border: none;
		border-radius: 4px;
		/* box-shadow: inset 0 0 0 2px #ccc; */
		font-size: 16px;
		padding: 8px 12px;
		outline: none;
		transition: box-shadow 0.3s, background-color 0.3s;
	}

	.stylish-input:focus {
		background-color: #fff;
		box-shadow: inset 0 0 0 2px #f1f1f1;
	}

	.lay-title {
		margin-top: 12px;
	}

	.c-box {
		background: #f5f5f5;
	}

	.c-box:hover {
		background-color: #0056B3;
	}

	.active-box {
		background-color: #0056B3;
	}

	.disabled-btn {
		background-color: #0057b35d !important;
		color: #0057b35d !important;

	}


	.perview-container {
		display: none;
	}

	.events-box {
		position: absolute;
		cursor: pointer;
		background-color: transparent;
		z-index: 9999;
	}
</style>

<div id="settingBox" class="body_container">
	<div class="title lay-title"> 跳转关联 </div>
	<div class="border" style="display: flex; align-items: center;justify-content:space-around;">
		<div>
			<div class="title"> from <a href="#" class="button mini-button" id="selectForm"> 选择 </a> </div>
			<div class="title" id="titleForm""> 选择节点FORM</div>
      <div id=" direcForm" class="border"
				style=" cursor: pointer;  width: 80px; height: 80px; box-sizing: border-box; position: relative; display: flex;justify-content: center;align-items: center;">
				<div class="c-box" style="border-radius: 2px; width: 40px; height: 5px; position: absolute; top: 10px;"
					data-type="from" data-direc="top"></div>
				<div class="c-box" style="border-radius: 2px;width: 40px; height: 5px; position: absolute; bottom: 10px;"
					data-type="from" data-direc="bottom"></div>
				<div class="c-box" style="border-radius: 2px;width: 5px; height: 40px; position: absolute; left: 10px;"
					data-type="from" data-direc="left"></div>
				<div class="c-box active-box"
					style="border-radius: 2px;width: 5px; height: 40px; position: absolute; right: 10px;" data-type="from"
					data-direc="right"></div>
				<div class="c-box" style="border-radius: 2px; width: 40px; height: 40px;"></div>
			</div>
		</div>
		<div style="flex-shrink: 0;"><a href="#" class="button mini-button disabled-btn" id="contect"> 连接</a> </div>
		<div>
			<div class="title"> to <a href="#" class="button mini-button " id="selectTo"> 选择 </a></div>
			<div class="title" id="titleTo"> 选择节点TO </div>
			<div id="direcTo" class="border"
				style=" cursor: pointer;  width: 80px; height: 80px; box-sizing: border-box; position: relative; display: flex;justify-content: center;align-items: center;">
				<div class="c-box" style="border-radius: 2px; width: 40px; height: 5px; position: absolute; top: 10px;"
					data-type="to" data-direc="top"></div>
				<div class="c-box" style="border-radius: 2px;width: 40px; height: 5px; position: absolute; bottom: 10px;"
					data-type="to" data-direc="bottom"></div>
				<div class="c-box active-box"
					style="border-radius: 2px;width: 5px; height: 40px; position: absolute; left: 10px;" data-type="to"
					data-direc="left"></div>
				<div class="c-box " style="border-radius: 2px;width: 5px; height: 40px; position: absolute; right: 10px;"
					data-type="to" data-direc="right"></div>
				<div class="c-box" style="border-radius: 2px; width: 40px; height: 40px;"></div>
			</div>
		</div>
	</div>
	<div class="border">
		<div class="title lay-title"> 颜色 </div>
		<input type="color" id="color" value="#E8178A">
	</div>
	<div class="border">
		<div class="title lay-title"> 大小 </div>
		<input type="number" id="strokeWeight" value="5" min="1" step="1" class="stylish-input" style=" width: 100%;" />
	</div>
	<div>
		<div class="title lay-title"> 预览设置 </div>
		<div class="border">
			<div class="title lay-title"> 入口 <a href="#" class="button mini-button" id="selectEntry"> 选择 </a></div>
			<div class="title lay-title" id="entryTitle">请选择节点(页面第一层子节点元素)</div>
		</div>
		<div class="border">
			<div class="title lay-title"> 宽 </div>
			<input type="number" id="perviewwidth" value="375" min="375" max="1920" step="1" class="stylish-input"
				style=" width: 100%;" />
		</div>
		<div class="border">
			<div class="title lay-title"> 高 </div>
			<input type="number" id="perviewheight" value="667" min="667" max="1080" step="1" class="stylish-input"
				style=" width: 100%;" />
		</div>
		<a href="#" class="button" id="perview"> 立即预览 </a>
	</div>
</div>
<div id="perviewbox" class="perview-container">
	<div id="perviewContentBox" style="position: relative;">
		<!-- <img id="perviewImg" style="width: 100%;height: 100%;" /> -->
	</div>
	<div style="text-align: center; margin-top: 2px;">
		<a href="#" class="button" id="gohome"> 返回设置 </a>
		<a href="#" class="button" id="pageUp" style="display: none;"> 上一页 </a>
		<a href="#" class="button" id="pageDown" style="display: none;"> 下一页 </a>
	</div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
	integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
	crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
	let formNode = {
		direc: 'right'
	}

	let toNode = {
		direc: 'left'
	}

	let contectStatus = false

	let entryNode = {}

	let perviewWidth = 375
	let perviewHeight = 667

	let perivewsDatas = []
	let perviewIndex = 0

	let perviewNext = false

	$('#selectForm').on('click', () => {
		parent.postMessage({
			pluginMessage: {
				type: 'select:form',
			}
		}, '*')
	})

	$('#selectTo').on('click', () => {
		parent.postMessage({
			pluginMessage: {
				type: 'select:to',
			}
		}, '*')
	})

	$('#direcTo').on('click', (event) => {
		const direc = getMutliLevelProperty(event, 'target.dataset.direc', '')
		if (direc) {
			toNode.direc = direc
			$(`div[data-type="to"]`).removeClass('active-box')
			$(`div[data-type="to"][data-direc="${direc}"]`).addClass('active-box')
		}
	})

	$('#direcForm').on('click', (event) => {
		console.log('event---', event)
		const direc = getMutliLevelProperty(event, 'target.dataset.direc', '')
		if (direc) {
			formNode.direc = direc
			$(`div[data-type="from"]`).removeClass('active-box')
			$(`div[data-type="from"][data-direc="${direc}"]`).addClass('active-box')
		}
	})

	$('#contect').on('click', () => {
		if (!contectStatus) return
		parent.postMessage({
			pluginMessage: {
				type: 'contect',
				datas: {
					formNode,
					toNode,
					color: $('#color').val(),
					strokeWeight: $('#strokeWeight').val(),
				}
			}
		}, '*')
	})

	$('#perview').on('click', () => {
		if (!entryNode.id) {
			alert('请选择节点(页面第一层子节点元素)')
			return
		}
		perviewHeight = $('#perviewheight').val()
		perviewWidth = $('#perviewwidth').val()
		parent.postMessage({
			pluginMessage: {
				type: 'perview',
				datas: {
					entry: entryNode.id,
					width: perviewWidth,
					height: perviewHeight,
				}
			}
		}, '*')
	})

	$('#gohome').on('click', () => {
		$('#settingBox').show()
		$('#perviewbox').hide()
		$('body').css('padding', '12px')
		parent.postMessage({
			pluginMessage: {
				type: 'reset',
			}
		}, '*')
	})

	$('#selectEntry').on('click', () => {
		parent.postMessage({
			pluginMessage: {
				type: 'select:entry',
			}
		}, '*')
	})

	window.onmessage = async (event) => {
		const { pluginId, pluginMessage } = event.data
		// if (pluginId !== "1_ZQp2EwQPLwdJ2ifcvUZ") return
		if (!pluginMessage) return
		const { type, datas } = pluginMessage
		if (type === 'select:form:done') {
			formNode = Object.assign(formNode, datas)
			$('#titleForm').html(formNode.name)
		} else if (type === 'select:to:done') {
			toNode = Object.assign(toNode, datas)
			$('#titleTo').html(toNode.name)
		} else if (type === 'select:entry:done') {
			entryNode = datas
			$('#entryTitle').html(entryNode.name)
		} else if (type === 'perview:done') {
			// console.log('perview:done', datas)
			const { rect, perivewdata } = datas
			$('#settingBox').hide()
			$('#perviewbox').show()
			$('body').css('padding', '0')
			$('#pageDown').hide()
			$('#pageUp').hide()
			perviewFlow(datas)
		}
		if (toNode.id && formNode.id) {
			contectStatus = true
			$('#contect').removeClass('disabled-btn')
		}

	}


	function getMutliLevelProperty(ctx, path, defaultVal) {
		let res = defaultVal;
		if (!(typeof path === 'string') || !isObject(ctx)) return res;
		let key = path.replace(/\[(\w+)\]/g, '.$1');
		key = key.replace(/^\./, '');
		const arr = key.split('.');
		for (let i = 0, count = arr.length; i < count; i++) {
			const p = arr[i];
			if ((isObject(ctx) || Array.isArray(ctx)) && p in ctx) {
				ctx = ctx[p];
			} else {
				return res;
			}
		}
		res = ctx;
		return res;
	}

	function isObject(obj) {
		var type = typeof obj;
		return type === 'function' || type === 'object' && !!obj;
	}

	function getBase(bytes) {
		return `data:image/png;base64,${bytes}`
	}

	function scaleImage(originalWidth, originalHeight, targetWidth, targetHeight) {
		if (originalWidth < targetWidth && originalHeight < targetHeight) {
			return [originalWidth, originalHeight, 1];
		}
		// 计算宽度和高度的缩放比例
		const widthScale = targetWidth / originalWidth;
		const heightScale = targetHeight / originalHeight;

		// 选择较小的缩放比例，以保持宽高比不变
		const scale = Math.min(widthScale, heightScale);

		// 计算新的宽度和高度
		const newWidth = originalWidth * scale;
		const newHeight = originalHeight * scale;

		return [newWidth, newHeight, scale];
	}

	function perviewFlow(datas, soucer = '') {
		const { rect, perivewdata, events } = datas
		const [nw, nh, scale] = scaleImage(rect.width, rect.height, perviewWidth, perviewHeight)
		const img = $('<img/>')
		img.attr('src', getBase(perivewdata))
			.css({ width: `${nw}px`, height: `${nh}px` })

		const eventBoxs = []
		if (Array.isArray(events)) {
			events.forEach(item => {
				const { id, toId, x, y, w, h } = item
				eventBoxs.push($(`<div class="events-box" data-type="event" data-toid="${toId}"  data-id="${id}"></div>`).css({
					left: `${x * scale}px`,
					top: `${y * scale}px`,
					width: `${w * scale}px`,
					height: `${h * scale}px`,
				}))
			})
		}
		if (!soucer) {
			perivewsDatas.push(datas)
			console.log('perivewsDatas---', perivewsDatas)
		}
		if (perviewNext) {
			perviewIndex = perviewIndex + 1
			perviewNext = false
			$('#pageUp').show()
			$('#pageDown').hide()
		}
		$('#perviewContentBox').empty().append(img, ...eventBoxs)
	}

	$('#perviewContentBox').on('click', event => {
		const type = getMutliLevelProperty(event, 'target.dataset.type', '')
		const toId = getMutliLevelProperty(event, 'target.dataset.toId', '')
		if (type === 'event' && toId) {
			const findex = perivewsDatas.findIndex(item => item.id === toId)
			console.log(findex)
			if (findex > -1) {
				perviewIndex = findex
				perviewFlow(perivewsDatas[findex], 'cache')
				$('#pageUp').show()
				$('#pageDown').hide()
				return
			}
			perviewNext = true
			parent.postMessage({
				pluginMessage: {
					type: 'perview',
					datas: {
						entry: toId,
					}
				}
			}, '*')
		}
	})

	$('#pageUp').on('click', () => {
		if (perviewIndex === 0) return
		perviewIndex = perviewIndex - 1
		perviewFlow(perivewsDatas[perviewIndex], 'cache')
		if (perviewIndex === 0) {
			$('#pageUp').hide()
		}
		$('#pageDown').show()
	})

	$('#pageDown').on('click', () => {
		if (perviewIndex === perivewsDatas.length - 1) return
		perviewIndex = perviewIndex + 1
		perviewFlow(perivewsDatas[perviewIndex], 'cache')
		if (perviewIndex === perivewsDatas.length - 1) {
			$('#pageDown').hide()
		}
		console.log(perivewsDatas)
		$('#pageUp').show()
	})
</script>